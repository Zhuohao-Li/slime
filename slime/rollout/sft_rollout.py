import logging

from slime.utils.mask_utils import MultiTurnLossMaskGenerator
from slime.utils.processing_utils import load_processor, load_tokenizer

__all__ = ["generate_rollout"]

logger = logging.getLogger(__name__)


TOKENIZER = None
PROCESSOR = None
MASK_GENERATOR = None
SAMPLE_PRINTED = False


def generate_rollout(args, rollout_id, data_buffer, evaluation=False):
    """An example to implement the generate_rollout function for an rule based rm rollout generation.

    Args:
        args: the whole args
        rollout_id: int, the id of the rollout, used for deterministic data generation
        data_buffer: the data buffer to store the generated samples
        evaluation: bool, whether the rollout is for evaluation or not

    Returns:
        list[Sample]: a list of samples generated by the rollout
    """
    assert not evaluation
    assert args.rollout_global_dataset

    global TOKENIZER, PROCESSOR, MASK_GENERATOR, SAMPLE_PRINTED
    if TOKENIZER is None:
        TOKENIZER = load_tokenizer(args.hf_checkpoint, trust_remote_code=True)

    if PROCESSOR is None:
        PROCESSOR = load_processor(args.hf_checkpoint, trust_remote_code=True)

    if MASK_GENERATOR is None:
        MASK_GENERATOR = MultiTurnLossMaskGenerator(TOKENIZER, tokenizer_type=args.loss_mask_type)

    samples = data_buffer.get_samples(args.rollout_batch_size)

    for i, sample in enumerate(samples):
        (sample,) = sample
        messages = sample.prompt
        tools = sample.metadata.get("tools", None)

        if PROCESSOR and sample.multimodal_inputs:
            if not isinstance(messages, list):
                raise ValueError(
                    "Multimodal SFT requires prompt as a list of messages. "
                    "Disable --apply-chat-template so the raw messages are preserved."
                )
            processor_output = PROCESSOR(text=messages, **sample.multimodal_inputs)
            input_ids = processor_output["input_ids"]
            if hasattr(input_ids, "tolist"):
                input_ids = input_ids.tolist()
            if input_ids and isinstance(input_ids[0], list):
                input_ids = input_ids[0]
            sample.multimodal_train_inputs = {
                k: v for k, v in processor_output.items() if k not in ["input_ids", "attention_mask"]
            } or None
            token_ids, loss_mask = MASK_GENERATOR.get_loss_mask_with_multimodal_alignment(
                messages, input_ids, tools=tools
            )
        else:
            if not isinstance(messages, list):
                raise ValueError(
                    "SFT rollout expects prompt as a list of messages. "
                    "Disable --apply-chat-template so the raw messages are preserved."
                )
            token_ids, loss_mask = MASK_GENERATOR.get_loss_mask(messages, tools=tools)

        response_length = MASK_GENERATOR.get_response_lengths([loss_mask])[0]

        sample.tokens = token_ids
        sample.response_length = response_length
        sample.reward = 0
        sample.loss_mask = loss_mask[-response_length:]

        if i == 0 and not SAMPLE_PRINTED:
            logger.info(
                f"sft_rollout::generate_rollout example data: {sample=} (raw){messages=} (raw){token_ids=} (raw){loss_mask=} {response_length=}"
            )
            SAMPLE_PRINTED = True

    return samples
